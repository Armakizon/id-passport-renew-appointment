<style>
  #distanceFilterContainer {
    margin-top: 1rem;
    position: relative;
  }
  #distanceFilterContainer label {
    font-weight: 600;
  }

  /* Shake animation */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }

  #distanceFilterContainer.shake {
    animation: shake 0.3s;
  }

  #distanceFilterError {
    color: red;
    margin-top: 0.3rem;
    font-size: 0.9rem;
    font-weight: 600;
  }
</style>

<div id="distanceFilterContainer">
  <label for="maxDistanceInput">Filter by max distance (km):</label>
  <input
    type="number"
    id="maxDistanceInput"
    min="0"
    step="0.1"
    placeholder="Enter max distance"
    class="form-control"
  />
  <button id="applyDistanceFilterBtn" class="btn btn-primary mt-2">Apply</button>
  <div id="distanceFilterError" style="display:none;"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const distanceContainer = document.getElementById("distanceFilterContainer");
    const maxDistanceInput = document.getElementById("maxDistanceInput");
    const applyBtn = document.getElementById("applyDistanceFilterBtn");
    const errorDiv = document.getElementById("distanceFilterError");
    const locationButtonsContainer = document.getElementById("locationButtons"); // branch buttons container
    const allRows = [...document.querySelectorAll("#appointmentsTable tbody tr")];

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = angle => (angle * Math.PI) / 180;
      const R = 6371; // Earth radius in km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Remove error message and shaking class
    function clearError() {
      errorDiv.style.display = "none";
      errorDiv.textContent = "";
      distanceContainer.classList.remove("shake");
    }

    // Show error message and shake container
    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.style.display = "block";
      distanceContainer.classList.add("shake");

      // Remove shake class after animation so it can repeat
      setTimeout(() => {
        distanceContainer.classList.remove("shake");
      }, 300);
    }

    applyBtn.addEventListener("click", () => {
      clearError();

      if (!window.userHasSelectedLocation) {
        showError("Please select your location to enable this filter.");
        return;
      }

      const maxDistance = parseFloat(maxDistanceInput.value);
      if (isNaN(maxDistance) || maxDistance < 0) {
        showError("Please enter a valid positive number for max distance.");
        return;
      }

      // Clear current selected branch buttons and activeBranchIds
      activeBranchIds = [];
      locationButtonsContainer.innerHTML = "";

      const dropdown = document.getElementById("locationDropdown");
      if (!dropdown) return;

      const [refLat, refLon] = dropdown.value.split(",").map(parseFloat);

      const branchesWithinDistance = [];

      allRows.forEach(row => {
        const branchId = row.getAttribute("data-branch-id");
        const rowLat = parseFloat(row.getAttribute("data-lat"));
        const rowLon = parseFloat(row.getAttribute("data-lon"));

        if (isNaN(rowLat) || isNaN(rowLon)) return;

        const dist = haversineDistance(refLat, refLon, rowLat, rowLon);

        if (dist <= maxDistance && !branchesWithinDistance.includes(branchId)) {
          branchesWithinDistance.push(branchId);
        }
      });

      branchesWithinDistance.forEach(branchId => {
        const row = allRows.find(r => r.getAttribute("data-branch-id") === branchId);
        const branchName = row ? row.children[0].textContent.trim() : "Unknown";

        activeBranchIds.push(branchId);

        const btn = document.createElement("button");
        btn.className = "btn btn-secondary btn-sm location-btn m-1";
        btn.textContent = branchName;
        btn.onclick = () => {
          activeBranchIds = activeBranchIds.filter(id => id !== branchId);
          locationButtonsContainer.removeChild(btn);
          updateTableVisibility();
        };
        locationButtonsContainer.appendChild(btn);
      });

      updateTableVisibility();
    });
  });
</script>
