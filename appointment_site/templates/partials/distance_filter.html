<style>
  #distanceFilterContainer {
    margin-top: 1rem;
  }
  #distanceFilterContainer label {
    font-weight: 600;
  }
  /* Visual cue for disabled controls */
  .disabled-opacity {
    opacity: 0.5;
    pointer-events: none;
  }
</style>

<div id="distanceFilterContainer">
  <label for="maxDistanceInput">Filter by max distance (km):</label>
  <input
    type="number"
    id="maxDistanceInput"
    min="0"
    step="0.1"
    placeholder="Enter max distance"
    class="form-control"
    disabled
  />
  <button id="applyDistanceFilterBtn" class="btn btn-primary mt-2" disabled>Apply</button>
  <small id="distanceFilterHelp" class="form-text text-muted mt-1">
    Please select your location to enable this filter.
  </small>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const distanceContainer = document.getElementById("distanceFilterContainer");
    const maxDistanceInput = document.getElementById("maxDistanceInput");
    const applyBtn = document.getElementById("applyDistanceFilterBtn");
    const helpText = document.getElementById("distanceFilterHelp");
    const locationButtonsContainer = document.getElementById("locationButtons");
    const allRows = [...document.querySelectorAll("#appointmentsTable tbody tr")];

    // Helper: Haversine formula
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = angle => (angle * Math.PI) / 180;
      const R = 6371; // Earth radius in km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Enable or disable filter controls based on location selection
    function updateDistanceFilterAccessibility() {
      const enabled = window.userHasSelectedLocation === true;

      maxDistanceInput.disabled = !enabled;
      applyBtn.disabled = !enabled;

      if (!enabled) {
        maxDistanceInput.classList.add("disabled-opacity");
        applyBtn.classList.add("disabled-opacity");
        helpText.style.display = "block";
      } else {
        maxDistanceInput.classList.remove("disabled-opacity");
        applyBtn.classList.remove("disabled-opacity");
        helpText.style.display = "none";
      }
    }

    // Initial accessibility update
    updateDistanceFilterAccessibility();

    // Apply max distance filter on button click
    applyBtn.addEventListener("click", () => {
      const maxDistance = parseFloat(maxDistanceInput.value);
      if (isNaN(maxDistance) || maxDistance < 0) {
        alert("Please enter a valid positive number for max distance.");
        return;
      }

      // Clear selected branch buttons and activeBranchIds
      activeBranchIds = [];
      locationButtonsContainer.innerHTML = "";

      // Get reference location from dropdown (or wherever you store it)
      const dropdown = document.getElementById("locationDropdown");
      if (!dropdown) return alert("Please select a reference location first.");

      const [refLat, refLon] = dropdown.value.split(",").map(parseFloat);

      // Find branches within maxDistance
      const branchesWithinDistance = [];

      allRows.forEach(row => {
        const branchId = row.getAttribute("data-branch-id");
        const rowLat = parseFloat(row.getAttribute("data-lat"));
        const rowLon = parseFloat(row.getAttribute("data-lon"));

        if (isNaN(rowLat) || isNaN(rowLon)) return;

        const dist = haversineDistance(refLat, refLon, rowLat, rowLon);

        if (dist <= maxDistance && !branchesWithinDistance.includes(branchId)) {
          branchesWithinDistance.push(branchId);
        }
      });

      // Add buttons for each branch within distance
      branchesWithinDistance.forEach(branchId => {
        const row = allRows.find(r => r.getAttribute("data-branch-id") === branchId);
        const branchName = row ? row.children[0].textContent.trim() : "Unknown";

        activeBranchIds.push(branchId);

        const btn = document.createElement("button");
        btn.className = "btn btn-secondary btn-sm location-btn m-1";
        btn.textContent = branchName;
        btn.onclick = () => {
          activeBranchIds = activeBranchIds.filter(id => id !== branchId);
          locationButtonsContainer.removeChild(btn);
          updateTableVisibility();
        };
        locationButtonsContainer.appendChild(btn);
      });

      updateTableVisibility();
    });

    // Expose accessibility updater for outside calls (e.g., location selection handlers)
    window.updateDistanceFilterAccessibility = updateDistanceFilterAccessibility;
  });
</script>
