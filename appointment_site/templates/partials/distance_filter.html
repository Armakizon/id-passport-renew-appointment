<div class="mb-3">
  <label for="distanceInput" class="form-label">Filter by distance (km)</label>
  <div class="d-flex align-items-start gap-2">
    <input
      type="number"
      class="form-control"
      id="distanceInput"
      placeholder="Enter km"
      min="1"
      style="max-width: 100px;"
    />
    <button id="applyDistanceFilter" class="btn btn-primary">Apply</button>
  </div>
  <div id="distanceError" class="mt-1 text-danger" style="display: none;">Please select your location to enable this filter.</div>
</div>

<script>
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const toRad = angle => (angle * Math.PI) / 180;
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const applyBtn = document.getElementById("applyDistanceFilter");
    const distanceInput = document.getElementById("distanceInput");
    const distanceError = document.getElementById("distanceError");

    applyBtn.addEventListener("click", () => {
      if (!window.userHasSelectedLocation || !userLat || !userLon) {
        distanceError.style.display = "block";
        distanceError.classList.add("shake");
        setTimeout(() => distanceError.classList.remove("shake"), 500);
        return;
      }

      const threshold = parseFloat(distanceInput.value);
      if (isNaN(threshold)) return;

      // Clear existing buttons
      const locationButtons = document.getElementById("locationButtons");
      if (locationButtons) locationButtons.innerHTML = "";
      activeBranchIds = [];

      {% for id, info in branch_map.items() %}
        const dist{{ id }} = haversineDistance(userLat, userLon, {{ info.latitude }}, {{ info.longitude }});
        if (dist{{ id }} <= threshold) {
          const btn = document.createElement("button");
          btn.className = "btn btn-secondary btn-sm location-btn me-1 mb-1";
          btn.textContent = "{{ info.branch_name }}";
          btn.onclick = () => {
            activeBranchIds = activeBranchIds.filter(bid => bid !== "{{ id }}");
            btn.remove();
            updateTableVisibility();
          };
          locationButtons.appendChild(btn);
          activeBranchIds.push("{{ id }}");
        }
      {% endfor %}

      updateTableVisibility();
      distanceError.style.display = "none";
    });
  });
</script>

<style>
  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    50% { transform: translateX(4px); }
    75% { transform: translateX(-4px); }
    100% { transform: translateX(0); }
  }

  .shake {
    animation: shake 0.3s ease-in-out;
  }
</style>
