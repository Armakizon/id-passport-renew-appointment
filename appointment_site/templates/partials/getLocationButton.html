<div id="getLocationButton" class="mb-3">
  <button id="getLocationBtn" class="btn btn-outline-primary" type="button">
    המיקום שלי
  </button>
</div>

<script>
document.getElementById("getLocationBtn")?.addEventListener("click", (e) => {
  e.preventDefault();

  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  // Haversine formula for distance
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const toRad = angle => (angle * Math.PI) / 180;
    const R = 6371; // Earth radius in km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude.toFixed(6);
    userLon = pos.coords.longitude.toFixed(6);
    const allRows = document.querySelectorAll("#appointmentsTable tbody tr");

    // Update distance column
	userHasSelectedLocation = true;
    allRows.forEach(row => {
      const rowLat = parseFloat(row.getAttribute("data-lat"));
      const rowLon = parseFloat(row.getAttribute("data-lon"));
      const distanceCell = row.children[3];

      if (!isNaN(rowLat) && !isNaN(rowLon)) {
        const dist = haversineDistance(userLat, userLon, rowLat, rowLon);
        distanceCell.textContent = dist.toFixed(2);
      } else {
        distanceCell.textContent = "-";
      }
    });

    // Update the dropdown with "Based on your location"
    const dropdown = document.getElementById("locationDropdown");
    if (dropdown) {
      const valueStr = `${userLat},${userLon}`;
      let found = false;

      for (const option of dropdown.options) {
        if (option.value === valueStr) {
          option.selected = true;
          found = true;
          break;
        }
      }

      if (!found) {
        const newOption = new Option("מחשב מרחק לפי המיקום שלך", valueStr, true, true);
        dropdown.appendChild(newOption);
      }

      // Manually trigger the change event to reapply any other logic
      dropdown.dispatchEvent(new Event("change"));
    }

  }, () => {
    alert("Failed to get your location.");
  });
});
</script>
