<!-- Location Dropdown -->
<form id="locationSelectForm" class="mb-3">
  <select id="filterLocationDropdown" class="form-select">
    <option selected disabled>בחר לשכה שתרצה לראות</option>
    {% for id, info in branch_map.items() %}
      <option value="{{ id }}" data-lat="{{ info.lat }}" data-lon="{{ info.lon }}">
        {{ info.name }} - {{ info.address }}
      </option>
    {% endfor %}
  </select>
</form>

<!-- Explanation text before email form -->
<p style="font-weight: 600; margin-bottom: 1rem;">
  4. הכניסו את המייל שלכם על מנת לקבל התראות כאשר תורים עם הגדרות המסנן שלכם מופיעים
</p>

<!-- Email form -->
<form id="notifyForm" method="POST" action="/subscribe">
  <div class="mb-3">
    <label for="email" class="form-label">כתובת מייל</label>
    <input type="email" class="form-control" id="email" name="email" required>
  </div>

  <!-- Hidden inputs -->
  <input type="hidden" name="locations" id="locationsInput">
  <input type="hidden" name="fromdate" id="fromDateInput">
  <input type="hidden" name="todate" id="toDateInput">

  <button type="submit" class="btn btn-primary">הוסף אותי לרשימת התפוצה</button>
</form>

<!-- Selected Location Buttons — now below email form -->
<div id="locationButtons" class="mb-3 d-flex flex-wrap">
  {% include "partials/location_buttons.html" %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropdown = document.getElementById("filterLocationDropdown");
    const locationButtons = document.getElementById("locationButtons");

    dropdown.addEventListener("change", () => {
      const selectedOption = dropdown.options[dropdown.selectedIndex];
      const branchId = selectedOption.value;
      const branchName = selectedOption.text;

      if (!window.activeBranchIds.includes(branchId)) {
        window.activeBranchIds.push(branchId);
        updateTableVisibility();

        const btn = document.createElement("button");
        btn.className = "btn btn-secondary btn-sm location-btn";
        btn.textContent = branchName;
        btn.onclick = () => {
          window.activeBranchIds = window.activeBranchIds.filter(id => id !== branchId);
          locationButtons.removeChild(btn);
          updateTableVisibility();
        };

        locationButtons.appendChild(btn);
      }

      dropdown.selectedIndex = 0;  // Reset to default
    });
  });
</script>
