<script>
document.getElementById("getLocationBtn")?.addEventListener("click", () => {
    if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;

        // Update URL query params silently (no page reload)
        const url = new URL(window.location);
        url.searchParams.set('lat', userLat);
        url.searchParams.set('lon', userLon);
        window.history.replaceState({}, '', url);

        const branchRows = [...document.querySelectorAll("#appointmentsTable tbody tr")];

        branchRows.forEach(row => {
            const branchId = row.getAttribute("data-branch-id");
            const lat = parseFloat(row.getAttribute("data-lat"));
            const lon = parseFloat(row.getAttribute("data-lon"));

            if (!isNaN(lat) && !isNaN(lon)) {
                const branchName = row.children[0].textContent.trim();
                addLocationFilter(branchId, branchName);
            }
        });
    }, () => {
        alert("Failed to get your location.");
    });
});

function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const toRad = d => d * Math.PI / 180;
    const R = 6371; // Radius of the earth in km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}
</script>
