<div id="locationButtons" class="mb-3">
  <button id="getLocationBtn" class="btn btn-primary">
    ğŸ“ Based on My Location
  </button>
</div>

<script>
document.getElementById("getLocationBtn")?.addEventListener("click", (e) => {
  e.preventDefault(); // prevent form/button default behavior

  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }

  // Haversine formula for distance
  function haversineDistance(lat1, lon1, lat2, lon2) {
    const toRad = angle => (angle * Math.PI) / 180;
    const R = 6371; // Earth radius in km
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLon = pos.coords.longitude;

    const allRows = document.querySelectorAll("#appointmentsTable tbody tr");

    allRows.forEach(row => {
      const rowLat = parseFloat(row.getAttribute("data-lat"));
      const rowLon = parseFloat(row.getAttribute("data-lon"));
      const distanceCell = row.children[3]; // Assumes 4th column is Distance (km)

      if (!isNaN(rowLat) && !isNaN(rowLon)) {
        const dist = haversineDistance(userLat, userLon, rowLat, rowLon);
        distanceCell.textContent = dist.toFixed(2);
      } else {
        distanceCell.textContent = "-";
      }
    });
  }, () => {
    alert("Failed to get your location.");
  });
});
</script>
