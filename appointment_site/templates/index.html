{% extends "base.html" %}
{% block title %}Appointment Dates{% endblock %}

{% block content %}
  <h2 class="mb-4">Appointment Dates</h2>

  <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterDrawer" aria-controls="filterDrawer">
    Open Filter
  </button>

  <p><strong>Last Updated:</strong> {{ last_updated }} ({{ time_since }})</p>

  {% include "partials/filter_drawer.html" %}
  {% include "partials/getLocationButton.html" %}
  {% include "partials/location_dropdown.html" %}
  {% include "partials/toggle_button.html" %}
  {% include "partials/appointments_table.html" %}
{% endblock %}

{% block scripts %}
  <script>
    const userLat = new URLSearchParams(window.location.search).get("lat");
    const userLon = new URLSearchParams(window.location.search).get("lon");

    const allRows = [...document.querySelectorAll("#appointmentsTable tbody tr")];
    const searchInput = document.getElementById("branchSearch");
    const resultsList = document.getElementById("branchResults");
    const getLocationButton = document.getElementById("getLocationButton");

    let activeBranchIds = [];
	window.userHasSelectedLocation = false;

    const branchNames = [...new Set(allRows.map(row => {
      const id = row.getAttribute("data-branch-id");
      const name = row.children[0].textContent.trim();
      return ${id}|${name};
    }))];

function updateTableVisibility() {
  const grouped = {};
  allRows.forEach(row => {
    const id = row.getAttribute("data-branch-id");
    (grouped[id] ||= []).push(row);
  });

  const urlParams = new URLSearchParams(window.location.search);
  const startDate = urlParams.get("start_date");
  const endDate = urlParams.get("end_date");

  allRows.forEach(row => row.style.display = "none");

  for (const [branchId, rows] of Object.entries(grouped)) {
    if (activeBranchIds.length === 0 || activeBranchIds.includes(branchId)) {
      const filteredRows = rows.filter(row => {
        const dateStr = row.children[2]?.innerText?.trim();  // Adjust index if needed
        if (!dateStr) return false;

        const rowDate = new Date(dateStr);
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;

        if (start && rowDate < start) return false;
        if (end && rowDate > end) return false;

        return true;
      });

      if (typeof showEarliestOnly !== "undefined" && showEarliestOnly) {
        filteredRows.sort((a, b) =>
          new Date(a.children[2].innerText) - new Date(b.children[2].innerText)
        )[0]?.style && (filteredRows[0].style.display = "");
      } else {
        filteredRows.forEach(row => row.style.display = "");
      }
    }
  }
}


  </script>

{% endblock %}