{% extends "base.html" %}
{% block title %}Appointment Dates{% endblock %}

{% block content %}
  <h2 class="mb-4">Appointment Dates</h2>

  <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterDrawer" aria-controls="filterDrawer">
    Open Filter
  </button>

  <p><strong>Last Updated:</strong> {{ last_updated }} ({{ time_since }})</p>

  {% include "partials/filter_drawer.html" %}
  {% include "partials/location_buttons.html" %}
  {% include "partials/toggle_button.html" %}
  {% include "partials/appointments_table.html" %}
{% endblock %}

{% block scripts %}
  <script>
    const userLat = new URLSearchParams(window.location.search).get("lat");
    const userLon = new URLSearchParams(window.location.search).get("lon");

    const allRows = [...document.querySelectorAll("#appointmentsTable tbody tr")];
    const searchInput = document.getElementById("branchSearch");
    const resultsList = document.getElementById("branchResults");
    const locationButtons = document.getElementById("locationButtons");

    let activeBranchIds = [];

    const branchNames = [...new Set(allRows.map(row => {
      const id = row.getAttribute("data-branch-id");
      const name = row.children[0].textContent.trim();
      return `${id}|${name}`;
    }))];

    function updateTableVisibility() {
      const grouped = {};
      allRows.forEach(row => {
        const id = row.getAttribute("data-branch-id");
        (grouped[id] ||= []).push(row);
      });

      allRows.forEach(row => row.style.display = "none");

      for (const [branchId, rows] of Object.entries(grouped)) {
        if (activeBranchIds.length === 0 || activeBranchIds.includes(branchId)) {
          if (typeof showEarliestOnly !== "undefined" && showEarliestOnly) {
            rows.sort((a, b) =>
              new Date(a.children[2].innerText) - new Date(b.children[2].innerText)
            )[0].style.display = "";
          } else {
            rows.forEach(row => row.style.display = "");
          }
        }
      }
    }

    function addLocationFilter(id, name) {
      if (activeBranchIds.includes(id)) return;
      activeBranchIds.push(id);
      updateTableVisibility();

      const btn = document.createElement("button");
      btn.className = "btn btn-secondary btn-sm location-btn";
      btn.textContent = name;
      btn.onclick = () => {
        activeBranchIds = activeBranchIds.filter(bid => bid !== id);
        locationButtons.removeChild(btn);
        updateTableVisibility();
      };
      locationButtons.appendChild(btn);
    }

    searchInput?.addEventListener("input", () => {
      const val = searchInput.value.toLowerCase();
      resultsList.innerHTML = "";
      if (!val) return;

      branchNames.filter(item => item.toLowerCase().includes(val)).slice(0, 5).forEach(match => {
        const [id, name] = match.split("|");
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action";
        li.textContent = name;
        li.onclick = () => {
          addLocationFilter(id, name);
          resultsList.innerHTML = "";
          searchInput.value = "";
        };
        resultsList.appendChild(li);
      });
    });
  </script>

  {% include "partials/sort_logic.html" %}
{% endblock %}
