{% extends "base.html" %}
{% block title %}Appointment Dates{% endblock %}
{% block content %}
    <h2 class="mb-4">Appointment Dates</h2>
	<button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterDrawer" aria-controls="filterDrawer">
	Open Filter
	</button>
    <p><strong>Last Updated:</strong> {{ last_updated }} ({{ time_since }})</p>
    {% include "partials/filter_drawer.html" %}
    {% include "partials/location_buttons.html" %}
    {% include "partials/toggle_button.html" %}
    {% include "partials/appointments_table.html" %}
	
{% endblock %}
{% block scripts %}
<script>
    const userLat = new URLSearchParams(window.location.search).get("lat");
    const userLon = new URLSearchParams(window.location.search).get("lon");

    const allRows = [...document.querySelectorAll("#appointmentsTable tbody tr")];
    const searchInput = document.getElementById("branchSearch");
    const resultsList = document.getElementById("branchResults");
    const locationButtons = document.getElementById("locationButtons");
    const earliestBtn = document.getElementById("toggleEarliestBtn");

    let activeBranchIds = [];
    let showEarliestOnly = false;

    const branchNames = [...new Set(allRows.map(row => {
        const id = row.getAttribute("data-branch-id");
        const name = row.children[0].textContent.trim();
        return `${id}|${name}`;
    }))];

    earliestBtn?.addEventListener("click", () => {
        showEarliestOnly = !showEarliestOnly;
        earliestBtn.textContent = showEarliestOnly ? "Show All Dates" : "Show Earliest Date per Branch";
        updateTableVisibility();
    });

    function updateTableVisibility() {
        const groupedByBranch = {};
        allRows.forEach(row => {
            const id = row.getAttribute("data-branch-id");
            if (!groupedByBranch[id]) groupedByBranch[id] = [];
            groupedByBranch[id].push(row);
        });

        allRows.forEach(row => row.style.display = "none");

        for (const [branchId, rows] of Object.entries(groupedByBranch)) {
            if (activeBranchIds.length === 0 || activeBranchIds.includes(branchId)) {
                if (showEarliestOnly) {
                    const sorted = rows.slice().sort((a, b) => {
                        const dateA = new Date(a.children[2].innerText.trim());
                        const dateB = new Date(b.children[2].innerText.trim());
                        return dateA - dateB;
                    });
                    sorted[0].style.display = "";
                } else {
                    rows.forEach(row => row.style.display = "");
                }
            }
        }
    }

    function addLocationFilter(id, name) {
        if (activeBranchIds.includes(id)) return;
        activeBranchIds.push(id);
        updateTableVisibility();

        const btn = document.createElement("button");
        btn.className = "btn btn-secondary btn-sm location-btn";
        btn.textContent = name;
        btn.onclick = () => {
            activeBranchIds = activeBranchIds.filter(bid => bid !== id);
            locationButtons.removeChild(btn);
            updateTableVisibility();
        };
        locationButtons.appendChild(btn);
    }

    searchInput.addEventListener("input", () => {
        const searchVal = searchInput.value.toLowerCase();
        resultsList.innerHTML = "";
        if (!searchVal) return;

        const matches = branchNames.filter(item => item.toLowerCase().includes(searchVal)).slice(0, 5);
        matches.forEach(match => {
            const [id, name] = match.split("|");
            const li = document.createElement("li");
            li.className = "list-group-item list-group-item-action";
            li.textContent = name;
            li.onclick = () => {
                addLocationFilter(id, name);
                resultsList.innerHTML = "";
                searchInput.value = "";
            };
            resultsList.appendChild(li);
        });
    });

	document.querySelectorAll("th.sortable").forEach(th => {
		th.addEventListener("click", () => {
			const column = parseInt(th.dataset.column);
			const tbody = document.querySelector("tbody");
			const rows = Array.from(tbody.rows);

			// Reset all sort indicators
			document.querySelectorAll("th.sortable").forEach(header => {
				header.dataset.sorted = "";
				header.querySelector(".sort-indicator").textContent = "";
			});

			// Sort rows
			const sorted = rows.sort((a, b) => {
				const valA = a.cells[column].textContent.trim();
				const valB = b.cells[column].textContent.trim();
				const isNumeric = !isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB));

				if (isNumeric) {
					return parseFloat(valA) - parseFloat(valB);
				} else {
					return valA.localeCompare(valB);
				}
			});

			let sortDirection = th.dataset.sorted === "asc" ? "desc" : "asc";
			th.dataset.sorted = sortDirection;

			if (sortDirection === "desc") {
				sorted.reverse();
			}

			// Update sort indicator arrow
			const indicator = th.querySelector(".sort-indicator");
			indicator.textContent = sortDirection === "asc" ? "↑" : "↓";

			// Apply sorted rows
			tbody.innerHTML = "";
			sorted.forEach(row => tbody.appendChild(row));
		});
	});
</script>
{% endblock %}
